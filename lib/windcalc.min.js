function drawResiduals(e,t){var a=[],s=[];for(i=0;i<t.length;i++)a[i]=[i,t[i]];var o=ss.linear_regression().data(a).line();for(i=0;i<t.length;i++)s[i]=Math.abs(t[i]-o(i));osc=Math.ceil(ss.max(s)),trend=Math.ceil(6*ss.linear_regression().data(a).m()),e.font="14px sans-serif",e.fillText("Oskillaatio: ±"+osc+"°",60,395),e.fillText("Trendi: "+trend+"°/h",220,395)}function drawCompass(e){e.font="10px sans-serif",e.lineWidth=1,e.setLineDash([1,1]),e.strokeStyle="rgb(60,60,60)",e.fillText("W",0,200),e.beginPath(),e.moveTo(20,200),e.lineTo(380,200),e.stroke(),e.fillText("E",390,200),e.fillText("S",195,395),e.beginPath(),e.moveTo(200,20),e.lineTo(200,380),e.stroke(),e.fillText("N",195,10),e.fillText("NE",341,59),e.beginPath(),e.moveTo(327,73),e.lineTo(73,327),e.stroke(),e.fillText("SW",59,341),e.fillText("SE",341,341),e.beginPath(),e.moveTo(327,327),e.lineTo(73,73),e.stroke(),e.fillText("NW",59,59),e.fillText("VIIM",0,10),e.strokeStyle="rgb(0,0,0)",e.lineWidth=2,e.setLineDash([1,0]),e.beginPath(),e.moveTo(25,5),e.lineTo(70,5),e.stroke(),e.fillText("KA",80,10),e.beginPath(),e.strokeStyle="rgb(0,240,0)",e.lineWidth=2,e.setLineDash([1,0]),e.moveTo(105,5),e.lineTo(150,5),e.stroke(),e.fillText("MIN",220,10),e.beginPath(),e.strokeStyle="rgb(240,0,0)",e.lineWidth=2,e.setLineDash([2,4]),e.moveTo(245,5),e.lineTo(290,5),e.stroke(),e.fillText("MAX",300,10),e.beginPath(),e.strokeStyle="rgb(0,0,240)",e.lineWidth=2,e.setLineDash([2,4]),e.moveTo(325,5),e.lineTo(370,5),e.stroke()}function drawLines(e,t,a,i){var s=90-t;0>s&&(s+=360),s=s/360*2*Math.PI;var o=200-170*Math.sin(s),l=200+170*Math.cos(s);e.strokeStyle=a,e.lineWidth=3,e.setLineDash(i),e.beginPath(),e.moveTo(200,200),e.lineTo(l,o),e.stroke()}function showResults(e,t){var a=[];_.each(t,function(e,t){var i={suure:"",aika:[],mittaus:[]};i.suure=t,outdiv="#"+t;var s=$(outdiv);s.empty(),s.append("<br>"+t);var o=0,l=[],r=(new Date).setHours(0,0,0,0);_.each(e.timeValuePairs,function(e){var t=(e.time-r)/6e4,a=Math.floor(t/60),s=t-60*a;mins=0==s?"00":s;var n=a+":"+mins;i.aika[o]=n,i.mittaus[o]=e.value,l[o]=o,o+=1}),kova=ss.sample_covariance(l,i.mittaus),varx=ss.sample_variance(l),s.append("<br> n: "+i.mittaus.length),s.append("<br> Viim: "+i.mittaus[i.mittaus.length-1]),s.append("<br> Min: "+ss.min(i.mittaus)),s.append("<br> Max: "+ss.max(i.mittaus)),s.append("<br> KA: "+ss.mean(i.mittaus).toFixed(1)),s.append("<br> Muutos: "+(6*kova/varx).toFixed(1)),a.push(i)});var i={labels:a[1].aika,datasets:[{fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:a[1].mittaus},{fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:a[2].mittaus}]},s=$("#wind").get(0).getContext("2d");Chart.defaults.global.scaleOverride=!0,Chart.defaults.global.scaleSteps=Math.ceil(ss.max(a[2].mittaus)/3),Chart.defaults.global.scaleStepWidth=3,Chart.defaults.global.scaleStartValue=0;var o=(new Chart(s).Line(i),a[3].mittaus[a[3].mittaus.length-1]),l=ss.min(a[3].mittaus),r=ss.max(a[3].mittaus),n=ss.mean(a[3].mittaus).toFixed(1),d=[2,4],m=[1,0],c=$("#compass").get(0).getContext("2d");c.clearRect(0,0,c.canvas.width,c.canvas.height),drawCompass(c),drawLines(c,o,"rgb(0,0,0)",m),drawLines(c,l,"rgb(240,0,0)",d),drawLines(c,r,"rgb(0,0,240)",d),drawLines(c,n,"rgb(0,240,0)",m),drawResiduals(c,a[3].mittaus)}function handleCallback(e){var t=$("#results"),a=$("#otime");t.empty(),a.empty(),t.append("<h3>"+e.locations[0].info.name+"</h3>"),tstamp=6e5*Math.floor((new Date).getTime()/6e5),tdate=new Date(tstamp),a.append("<br>Aika: "+tdate.getHours()+":"+("0"+tdate.getMinutes()).slice(-2)),e&&showResults(t,e.locations[0].data)}function getData(e,t){fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:e,storedQueryId:STORED_QUERY_OBSERVATION,requestParameter:"t2m,ws_10min,wg_10min,wd_10min,p_sea",end:6e5*Math.floor((new Date).getTime()/6e5),begin:6e5*Math.floor((new Date).getTime()/6e5)-108e5,fmisid:t,callback:function(e,t){handleCallback(e,t)}})}function dothis(){var e=$("#select1").val();switch(e){case"1":locid="101042";case"2":locid="101030";break;case"3":locid="101039";break;case"4":locid="101023";break;case"5":locid="101022";break;case"6":locid="101029";break;case"7":locid="100996";break;case"8":locid="101003";break;case"9":locid="100997";break;case"10":locid="100969";break;case"11":locid="100965";break;case"12":locid="100946"}getData(SERVER_URL,locid)}var STORED_QUERY_OBSERVATION="fmi::observations::weather::multipointcoverage",STORED_QUERY_FORECAST="fmi::forecast::hirlam::surface::point::multipointcoverage",SERVER_URL="http://data.fmi.fi/fmi-apikey/04b1145b-d491-4d85-8a30-c542108ee5b9/wfs";